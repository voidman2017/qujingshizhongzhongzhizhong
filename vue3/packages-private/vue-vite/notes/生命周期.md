### Vue3 生命周期重点解析

#### 一、Vue3 生命周期钩子变化

- **组合式 API**：生命周期钩子以 `onX` 形式命名（如 `onMounted`），需在 `setup()` 中注册。
- **废弃的钩子**：`beforeCreate` 和 `created` 被 `setup()` 替代，`beforeDestroy` 和 `destroyed` 改为 `onBeforeUnmount` 和 `onUnmounted`。

---

#### 二、各个生命周期的特点及注意事项

1. **onBeforeMount**

   - **时机**：组件挂载到 DOM **前**执行。
   - **注意**：此时无法访问 DOM 元素。

2. **onMounted**

   - **时机**：组件挂载到 DOM **后**执行。
   - **用途**：初始化 DOM 操作、异步请求。
   - **注意**：子组件的 `onMounted` 先于父组件执行。

3. **onBeforeUpdate**

   - **时机**：响应式数据变化后，DOM 更新**前**触发。
   - **用途**：获取更新前的状态。

4. **onUpdated**

   - **时机**：DOM 更新**后**触发。
   - **注意**：避免在此修改响应式数据，可能导致无限循环。

5. **onBeforeUnmount**

   - **时机**：组件卸载**前**触发。
   - **用途**：清理定时器、取消网络请求、解绑事件。

6. **onUnmounted**

   - **时机**：组件卸载**后**触发。
   - **注意**：此时 DOM 元素已被移除。

7. **onActivated / onDeactivated**

   - **时机**：被 `<keep-alive>` 缓存的组件**激活/失活**时触发。
   - **用途**：恢复/保存组件状态（如滚动位置）。

8. **错误处理钩子**

   - **onErrorCaptured**：捕获子孙组件的错误。
   - **onRenderTracked / onRenderTriggered**（调试用）：追踪响应式依赖。

---

#### 三、父子组件生命周期顺序

1. **挂载阶段**父 `setup()` → 父 `onBeforeMount` → 子组件挂载（子 `setup()` → 子 `onBeforeMount` → 子 `onMounted`） → 父 `onMounted`。
2. **更新阶段**父 `onBeforeUpdate` → 子 `onBeforeUpdate` → 子 `onUpdated` → 父 `onUpdated`。
3. **卸载阶段**
   父 `onBeforeUnmount` → 子 `onBeforeUnmount` → 子 `onUnmounted` → 父 `onUnmounted`。

---

#### 四、Keep-Alive 组件的生命周期

- **首次加载**：触发 `onMounted` → `onActivated`。
- **切换隐藏**：触发 `onDeactivated`（组件未销毁）。
- **再次显示**：触发 `onActivated`（不再触发 `onMounted`）。
- **彻底销毁**：离开路由且未被缓存时，触发 `onUnmounted`。

---

#### 五、注意事项

1. **异步操作**

   - 在 `onMounted` 中发起请求，需在 `onBeforeUnmount` 中取消（如 AbortController）。
   - 避免在 `onUpdated` 中修改数据，防止循环更新。

2. **组合式 API 使用**

   ```javascript
   import { onMounted } from 'vue';
   setup() {
     onMounted(() => { /* ... */ });
     // 可注册多个同名钩子，按顺序执行
   }
   ```

3. **与 Options API 混用**

   - 组合式 API 的钩子优先于 Options API 执行（如 `setup()` 中的 `onMounted` 先于 `mounted()` 触发）。

4. **服务端渲染（SSR）**

   - 避免在 `onMounted` 中访问浏览器特有 API，需使用 `onServerPrefetch` 处理服务端数据预取。

---

#### 六、其他相关

- **Suspense 组件**：处理异步组件加载状态，可配合 `<template #fallback>` 定义加载中 UI。
- **路由生命周期**：结合 Vue Router 的导航守卫（如 `onBeforeRouteLeave`）控制页面跳转。

---

#### 总结

Vue3 生命周期围绕组合式 API 设计，父子组件顺序遵循“父进子出”，`<keep-alive>` 通过 `onActivated`/`onDeactivated` 管理缓存状态。合理利用钩子处理初始化、副作用清理及性能优化，是高效开发的关键。
