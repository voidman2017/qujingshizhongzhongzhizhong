<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vue 3 å“åº”å¼ç³»ç»Ÿå›¾è§£</title>
    <style>
      body {
        font-family: 'Arial', sans-serif;
        margin: 0;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #333;
      }
      .container {
        max-width: 1400px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      }
      h1 {
        text-align: center;
        color: #2c3e50;
        margin-bottom: 40px;
        font-size: 2.5em;
      }
      .diagram-section {
        margin-bottom: 50px;
        padding: 25px;
        border: 2px solid #e74c3c;
        border-radius: 10px;
        background: #fdf2f2;
      }
      .section-title {
        font-size: 1.8em;
        color: #e74c3c;
        margin-bottom: 20px;
        text-align: center;
        font-weight: bold;
      }
      .flow-diagram {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        align-items: center;
        gap: 20px;
        margin: 30px 0;
      }
      .box {
        padding: 15px 20px;
        border-radius: 8px;
        text-align: center;
        font-weight: bold;
        min-width: 120px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
      }
      .box:hover {
        transform: translateY(-5px);
      }
      .reactive-box {
        background: #3498db;
        color: white;
      }
      .proxy-box {
        background: #e67e22;
        color: white;
      }
      .effect-box {
        background: #27ae60;
        color: white;
      }
      .dep-box {
        background: #9b59b6;
        color: white;
      }
      .render-box {
        background: #e74c3c;
        color: white;
      }
      .arrow {
        font-size: 2em;
        color: #34495e;
        font-weight: bold;
      }
      .code-block {
        background: #2c3e50;
        color: #ecf0f1;
        padding: 20px;
        border-radius: 8px;
        font-family: 'Courier New', monospace;
        margin: 15px 0;
        overflow-x: auto;
      }
      .highlight {
        background: #f39c12;
        color: #2c3e50;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: bold;
      }
      .step-list {
        list-style: none;
        padding: 0;
      }
      .step-list li {
        background: #ecf0f1;
        margin: 10px 0;
        padding: 15px;
        border-left: 5px solid #3498db;
        border-radius: 5px;
      }
      .step-number {
        background: #3498db;
        color: white;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin-right: 10px;
        font-weight: bold;
      }
      .architecture-diagram {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
        margin: 30px 0;
      }
      .layer {
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        color: white;
        font-weight: bold;
      }
      .template-layer {
        background: #e74c3c;
      }
      .proxy-layer {
        background: #f39c12;
      }
      .reactive-layer {
        background: #27ae60;
      }
      .connection-line {
        height: 3px;
        background: #34495e;
        margin: 10px 0;
        position: relative;
      }
      .connection-line::after {
        content: 'â†’';
        position: absolute;
        right: -10px;
        top: -10px;
        font-size: 20px;
        color: #34495e;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸš€ Vue 3 å“åº”å¼ç³»ç»Ÿå®Œæ•´å›¾è§£</h1>

      <!-- æ•´ä½“æ¶æ„å›¾ -->
      <div class="diagram-section">
        <div class="section-title">ğŸ“‹ æ•´ä½“æ¶æ„å±‚æ¬¡</div>
        <div class="architecture-diagram">
          <div class="layer template-layer">
            <h3>æ¨¡æ¿å±‚</h3>
            <p>Template/JSX</p>
            <p>{{ data }}</p>
          </div>
          <div class="layer proxy-layer">
            <h3>ä»£ç†å±‚</h3>
            <p>PublicInstanceProxy</p>
            <p>å±æ€§è®¿é—®æ‹¦æˆª</p>
          </div>
          <div class="layer reactive-layer">
            <h3>å“åº”å¼å±‚</h3>
            <p>Reactive/Ref</p>
            <p>ä¾èµ–è¿½è¸ª</p>
          </div>
        </div>
        <div class="connection-line"></div>
        <div style="text-align: center; margin-top: 20px">
          <strong
            >æ•°æ®æµå‘ï¼šæ¨¡æ¿è®¿é—® â†’ ä»£ç†æ‹¦æˆª â†’ å“åº”å¼æ•°æ® â†’ ä¾èµ–æ”¶é›† â†’
            æ›´æ–°é€šçŸ¥</strong
          >
        </div>
      </div>

      <!-- å“åº”å¼å¯¹è±¡åˆ›å»ºæµç¨‹ -->
      <div class="diagram-section">
        <div class="section-title">ğŸ”§ å“åº”å¼å¯¹è±¡åˆ›å»ºæµç¨‹</div>
        <div class="flow-diagram">
          <div class="box reactive-box">reactive(obj)</div>
          <div class="arrow">â†’</div>
          <div class="box proxy-box">new Proxy(obj, handlers)</div>
          <div class="arrow">â†’</div>
          <div class="box dep-box">åˆ›å»º targetMap</div>
          <div class="arrow">â†’</div>
          <div class="box effect-box">è¿”å›ä»£ç†å¯¹è±¡</div>
        </div>
        <pre class="code-block">
// æ ¸å¿ƒå®ç°
function reactive(target) {
  return new Proxy(target, {
    get(target, key, receiver) {
      const result = Reflect.get(target, key, receiver)
      <span class="highlight">track(target, key)</span>  // ä¾èµ–æ”¶é›†
      return result
    },
    set(target, key, value, receiver) {
      const result = Reflect.set(target, key, value, receiver)
      <span class="highlight">trigger(target, key)</span>  // è§¦å‘æ›´æ–°
      return result
    }
  })
}
        </pre>
      </div>

      <!-- ä¾èµ–æ”¶é›†è¿‡ç¨‹ -->
      <div class="diagram-section">
        <div class="section-title">ğŸ“Š ä¾èµ–æ”¶é›†è¿‡ç¨‹ (track)</div>
        <div class="flow-diagram">
          <div class="box render-box">æ¸²æŸ“å‡½æ•°æ‰§è¡Œ</div>
          <div class="arrow">â†’</div>
          <div class="box proxy-box">è®¿é—® obj.count</div>
          <div class="arrow">â†’</div>
          <div class="box reactive-box">è§¦å‘ get æ‹¦æˆªå™¨</div>
          <div class="arrow">â†’</div>
          <div class="box dep-box">track(target, key)</div>
          <div class="arrow">â†’</div>
          <div class="box effect-box">æ”¶é›† activeEffect</div>
        </div>
        <ol class="step-list">
          <li>
            <span class="step-number">1</span>è·å–å½“å‰æ´»è·ƒçš„ Effect
            (activeEffect)
          </li>
          <li>
            <span class="step-number">2</span>ä» targetMap ä¸­è·å– target å¯¹åº”çš„
            depsMap
          </li>
          <li>
            <span class="step-number">3</span>ä» depsMap ä¸­è·å– key å¯¹åº”çš„ Dep
            å®ä¾‹
          </li>
          <li>
            <span class="step-number">4</span>å°† activeEffect æ·»åŠ åˆ° Dep
            çš„è®¢é˜…è€…åˆ—è¡¨
          </li>
          <li>
            <span class="step-number">5</span>åœ¨ Effect ä¸­è®°å½•è¿™ä¸ªä¾èµ–å…³ç³»
          </li>
        </ol>
        <pre class="code-block">
// ä¾èµ–æ”¶é›†æ ¸å¿ƒé€»è¾‘
function track(target, key) {
  if (!activeEffect) return
  
  let depsMap = targetMap.get(target)
  if (!depsMap) {
    targetMap.set(target, (depsMap = new Map()))
  }
  
  let dep = depsMap.get(key)
  if (!dep) {
    <span class="highlight">depsMap.set(key, (dep = new Dep()))</span>
  }
  
  dep.track()  // å°† activeEffect æ·»åŠ åˆ°ä¾èµ–åˆ—è¡¨
}
</pre>
      </div>

      <!-- ä¾èµ–è§¦å‘è¿‡ç¨‹ -->
      <div class="diagram-section">
        <div class="section-title">ğŸ”¥ ä¾èµ–è§¦å‘è¿‡ç¨‹ (trigger)</div>
        <div class="flow-diagram">
          <div class="box reactive-box">obj.count++</div>
          <div class="arrow">â†’</div>
          <div class="box proxy-box">è§¦å‘ set æ‹¦æˆªå™¨</div>
          <div class="arrow">â†’</div>
          <div class="box dep-box">trigger(target, key)</div>
          <div class="arrow">â†’</div>
          <div class="box effect-box">é€šçŸ¥æ‰€æœ‰ Effect</div>
          <div class="arrow">â†’</div>
          <div class="box render-box">é‡æ–°æ¸²æŸ“</div>
        </div>
        <ol class="step-list">
          <li>
            <span class="step-number">1</span>æ•°æ®å‘ç”Ÿå˜åŒ–ï¼Œè§¦å‘ set æ‹¦æˆªå™¨
          </li>
          <li>
            <span class="step-number">2</span>è°ƒç”¨ trigger å‡½æ•°ï¼ŒæŸ¥æ‰¾ç›¸å…³ä¾èµ–
          </li>
          <li><span class="step-number">3</span>éå† Dep ä¸­çš„æ‰€æœ‰è®¢é˜…è€…</li>
          <li>
            <span class="step-number">4</span>è°ƒç”¨æ¯ä¸ª Effect çš„ scheduler
            æˆ–ç›´æ¥æ‰§è¡Œ
          </li>
          <li>
            <span class="step-number">5</span>æ›´æ–°ä»»åŠ¡åŠ å…¥è°ƒåº¦é˜Ÿåˆ—ï¼Œå¼‚æ­¥æ‰§è¡Œ
          </li>
        </ol>
      </div>

      <!-- ç»„ä»¶æ¸²æŸ“æµç¨‹ -->
      <div class="diagram-section">
        <div class="section-title">ğŸ¨ ç»„ä»¶æ¸²æŸ“ä¸å“åº”å¼ç»“åˆ</div>
        <div class="flow-diagram">
          <div class="box render-box">ç»„ä»¶åˆå§‹åŒ–</div>
          <div class="arrow">â†’</div>
          <div class="box proxy-box">åˆ›å»ºç»„ä»¶ä»£ç†</div>
          <div class="arrow">â†’</div>
          <div class="box effect-box">setupRenderEffect</div>
          <div class="arrow">â†’</div>
          <div class="box reactive-box">æ¸²æŸ“å‡½æ•°æ‰§è¡Œ</div>
          <div class="arrow">â†’</div>
          <div class="box dep-box">ä¾èµ–æ”¶é›†</div>
        </div>
        <pre class="code-block">
// ç»„ä»¶æ¸²æŸ“ Effect è®¾ç½®
function setupRenderEffect(instance) {
  const componentUpdateFn = () => {
    if (!instance.isMounted) {
      // é¦–æ¬¡æ¸²æŸ“
      const subTree = <span class="highlight">renderComponentRoot(instance)</span>
      patch(null, subTree, container)
      instance.isMounted = true
    } else {
      // æ›´æ–°æ¸²æŸ“
      const nextTree = <span class="highlight">renderComponentRoot(instance)</span>
      patch(prevTree, nextTree, container)
    }
  }
  
  const effect = new ReactiveEffect(componentUpdateFn)
  effect.scheduler = () => <span class="highlight">queueJob(update)</span>  // å¼‚æ­¥æ›´æ–°
  
  const update = () => effect.run()
  update()
}
</pre>
      </div>

      <!-- æ•°æ®ç»“æ„å›¾ -->
      <div class="diagram-section">
        <div class="section-title">ğŸ—‚ï¸ æ ¸å¿ƒæ•°æ®ç»“æ„å…³ç³»</div>
        <div
          style="
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin: 20px 0;
          "
        >
          <div>
            <h4>WeakMap ç»“æ„</h4>
            <pre class="code-block">
targetMap: WeakMap {
  target1 => Map {
    'key1' => Dep { subs: [effect1, effect2] }
    'key2' => Dep { subs: [effect3] }
  }
  target2 => Map {
    'key1' => Dep { subs: [effect1] }
  }
}
</pre
            >
          </div>
          <div>
            <h4>Dep ç±»ç»“æ„</h4>
            <pre class="code-block">
class Dep {
  version = 0
  activeLink = undefined
  subs = undefined
  
  track() { /* æ”¶é›†ä¾èµ– */ }
  trigger() { /* è§¦å‘æ›´æ–° */ }
  notify() { /* é€šçŸ¥è®¢é˜…è€… */ }
}
</pre
            >
          </div>
        </div>
      </div>

      <!-- å®Œæ•´ç¤ºä¾‹ -->
      <div class="diagram-section">
        <div class="section-title">ğŸ’¡ å®Œæ•´ç¤ºä¾‹æ¼”ç¤º</div>
        <pre class="code-block">
// 1. åˆ›å»ºå“åº”å¼æ•°æ®
const state = <span class="highlight">reactive({ count: 0 })</span>

// 2. åˆ›å»º Effect (æ¨¡æ‹Ÿç»„ä»¶æ¸²æŸ“)
<span class="highlight">effect(() => {
  console.log('æ¸²æŸ“:', state.count)  // ä¾èµ–æ”¶é›†å‘ç”Ÿåœ¨è¿™é‡Œ
})</span>

// 3. æ•°æ®å˜åŒ–è§¦å‘æ›´æ–°
setTimeout(() => {
  <span class="highlight">state.count++</span>  // è§¦å‘é‡æ–°æ¸²æŸ“
}, 1000)
</pre>
        <div
          style="
            background: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
          "
        >
          <h4>æ‰§è¡Œæµç¨‹ï¼š</h4>
          <p>
            <strong>åˆå§‹åŒ–ï¼š</strong> reactive() â†’ åˆ›å»º Proxy â†’ effect() æ‰§è¡Œ â†’
            è®¿é—® state.count â†’ track() æ”¶é›†ä¾èµ–
          </p>
          <p>
            <strong>æ›´æ–°ï¼š</strong> state.count++ â†’ è§¦å‘ set â†’ trigger() â†’ é€šçŸ¥
            Effect â†’ é‡æ–°æ‰§è¡Œæ¸²æŸ“å‡½æ•°
          </p>
        </div>
      </div>

      <!-- ä¼˜åŒ–ç‰¹æ€§ -->
      <div class="diagram-section">
        <div class="section-title">âš¡ æ€§èƒ½ä¼˜åŒ–ç‰¹æ€§</div>
        <div
          style="
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
          "
        >
          <div
            class="box"
            style="background: #16a085; color: white; padding: 20px"
          >
            <h4>è®¿é—®ç¼“å­˜ (accessCache)</h4>
            <p>é¿å…é‡å¤çš„å±æ€§æŸ¥æ‰¾ï¼Œæé«˜æ¸²æŸ“æ€§èƒ½</p>
          </div>
          <div
            class="box"
            style="background: #8e44ad; color: white; padding: 20px"
          >
            <h4>å¼‚æ­¥æ›´æ–°é˜Ÿåˆ—</h4>
            <p>åˆå¹¶å¤šæ¬¡åŒæ­¥æ›´æ–°ï¼Œå‡å°‘é‡å¤æ¸²æŸ“</p>
          </div>
          <div
            class="box"
            style="background: #d35400; color: white; padding: 20px"
          >
            <h4>åŒå‘é“¾è¡¨ä¼˜åŒ–</h4>
            <p>é«˜æ•ˆçš„ä¾èµ–æ·»åŠ å’Œç§»é™¤æ“ä½œ</p>
          </div>
          <div
            class="box"
            style="background: #c0392b; color: white; padding: 20px"
          >
            <h4>ç‰ˆæœ¬å·æœºåˆ¶</h4>
            <p>é¿å…ä¸å¿…è¦çš„ä¾èµ–æ£€æŸ¥å’Œæ›´æ–°</p>
          </div>
        </div>
      </div>
    </div>

    <script>
      // æ·»åŠ ä¸€äº›äº¤äº’æ•ˆæœ
      document.querySelectorAll('.box').forEach(box => {
        box.addEventListener('click', function () {
          this.style.transform = 'scale(1.1)'
          setTimeout(() => {
            this.style.transform = 'scale(1)'
          }, 200)
        })
      })

      // ä»£ç é«˜äº®åŠ¨ç”»
      document.querySelectorAll('.highlight').forEach((el, index) => {
        setTimeout(() => {
          el.style.animation = 'pulse 1s ease-in-out'
        }, index * 500)
      })

      // æ·»åŠ  CSS åŠ¨ç”»
      const style = document.createElement('style')
      style.textContent = `
            @keyframes pulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.05); }
                100% { transform: scale(1); }
            }
        `
      document.head.appendChild(style)
    </script>
  </body>
</html>
